# Processing Guide
# Recommended Serial Acquisition Steps
The ACS communicates over RS232 at 115200-8-N-1.

| **Step** | **Step Description**      | **Notes**                                                                                                                                                                                              |
|----------|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 0.0      | Find Packet               | Read the serial stream and parse out a full ACS packet.                                                                                                                                                |
| 0.1      | Split/Parse Packet        | Split a packet into its raw constituents as defined by the [ACS manual](https://www.seabird.com/asset-get.download.jsa?id=69833852764). (e.g. record_length, a_signal, raw_internal_temperature, etc). |
| 0.2      | Run Syntax Test           | Verify that the packet length matches the record length and verify the checksum.                                                                                                                       |
| 0.3      | Run Gap Test              | Check the assigned packet timestamp and the serial port buffer for pile up.                                                                                                                            |
| 0.4      | Import ACS Device File    | The serial number from the parsed packet can be used to automatically identify a corresponding device file.                                                                                            | 
| 0.5      | Calibrate Packet          | Calibrate the packet using the device file to produce products in engineering units (e.g. a_m, internal_temperature)                                                                                   |
| 0.6      | Import TSCor Data         | TS-correction does take time to perform each loop, but can be done in a single thread.                                                                                                                 |                    
| 0.7      | TS Correct Packet         | OPTIONAL: Apply TS correction to data in the packet, if ancillary temperature and salinity are available. (e.g. a_mts)                                                                                 |
| 0.8      | Run Additional QAQC Tests | OPTIONAL: Run elapsed time test, internal temperature test, and Inf Nan Test on uncorrected data. These test can probably be done during data acquisition on a single thread.                          |


# Recommended Processing Steps
Note: Many of the steps in the table below are described further in the Sea-Bird Scientific [ACS Protocol Document (Rev Q)](https://www.seabird.com/asset-get.download.jsa?id=69833852764).
[GSW](https://pypi.org/project/gsw/) is the Pythonic implementation of the Gibbs-SeaWater for TEOS-10.


| **Step** | **Step Description**                                                                             | **Supported in *acspype*?** | **Description**                                                                                                                                                                                                                                                           | **Notes**                                                                                                                                                                                                                                                                                                                                                                 |
|----------|--------------------------------------------------------------------------------------------------|-----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1.0      | Import ACS Device File and TSCor                                                                 | Yes                         | Import a corresponding ACS device file (ACS-XXX.dev) and TS-correction coefficients (TS4.cor). These files are provided by Sea-Bird Scientific.                                                                                                                           | The TS4.cor file from SBS should be the same for all ACS. *acspype* has these coefficients hardcoded. It is strongly recommended to rename the .dev file to ACS-XXXXX_YYYY-MM-DD.dev, where XXXXX is the zero padded serial number (00011) and YYYY-MM-DD is the date of calibration in the device file, to avoid overwritting device files if stored in the same folder. |
| 1.1      | Compute Internal Temperature                                                                     | Yes                         | Compute internal temperature of the sensor from raw counts. This data is needed for calculation of the measured (a_m, c_m) coefficients.                                                                                                                                  | The external temperature isn't used in processing ACS data, but can also be calculated at this stage.                                                                                                                                                                                                                                                                     |
| 1.2      | OPTIONAL: Calculate Absolute Salinity and Conservative Temperature                               | No (Use GSW)                | The use of TEOS-10 salinity/temperature over EOS-80 salinity/temperature variable should not impact the TS-correction of spectra significantly. However, it is recommended, particularly if other physical properties of seawater of interest in analysis (e.g. density). | This requires a co-located CTD or TSG.                                                                                                                                                                                                                                                                                                                                    |
| 1.3      | Compute Uncorrected Absorption (a_uncorrected) and Attenuation (c_uncorrected)                   | Yes                         | Compute the uncorrected absorption and attenuation in inverse meters (m^-1).                                                                                                                                                                                              | This is the first step in the processing chain where the ACS data is converted from raw counts to engineering units. Comparing uncorrected values may be useful in identifying debris or bubbles in the flow path.                                                                                                                                                        |
| 1.4      | Compute Measured Absorption (a_m_discontinuity) and Attenuation (c_m)                            | Yes                         | Compute the measured absorption and attenuation in inverse meters (m^-1).                                                                                                                                                                                                 | *acspype* uses the measured (m) subscript because the filtration state of the medium is unknown. Use of the particulate-gelbstoff (pg), particulate (p), and gelbstoff (g) subscripts should be applied later at user discretion.                                                                                                                                         |
| 1.5      | OPTIONAL: Apply User-Collected Pure Water Coefficients                                           | No                          | Apply an additional pure water offset derived by the user.                                                                                                                                                                                                                | This may require multiple calibrations. Linear interpolation between two or more user created offsets will help assess and remove sensor drift.                                                                                                                                                                                                                           |
| 1.6      | OPTIONAL, RECOMMENDED: Correct Measured Absorption (a_m) and Attenuation (c_m) for Discontinuity | Yes                         | Correct the measured absorption and attenuation for the observed discontinuity jump that occurs roughly halfway in each spectra.                                                                                                                                          | This step applies a scalar offset to the second half of the spectra to create a smoother spectrum.                                                                                                                                                                                                                                                                        |
| 1.7      | Time Lag Correction                                                                              | No                          | Using known volume, flow rate, and co-located sensors, shift ancillary variables to match the time the same water enters the ACS.                                                                                                                                         | This requires a nearby CTD or TSG and knowledge of the flow rate of water pumped through the ACS.                                                                                                                                                                                                                                                                         |
| 1.8      | Compute TS-Corrected Absorption (a_mts) and Attenuation (c_mts)                                  | Yes                         | Using ancillary temperature (conservative temperature) and salinity (absolute salinity), correct spectra for the effect of temperature and salinity.                                                                                                                      | This requires a nearby CTD or TSG. DO NOT USE THE ACS EXTERNAL TEMPERATURE.                                                                                                                                                                                                                                                                                               |
| 1.9      | Zero Shift Correction Absorption (a_mts) and Attenuation (c_mts)                                 | Yes                         | Shift values between -0.005 and 0 to be 0.                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                           |
| 2.0      | OPTIONAL: A-C Lag Correction                                                                     | No                          | This step is only necessary if flow cells are plumbed in series and if there analysis is done on full resolution data.                                                                                                                                                    | OPTIONAL: This only applies if the flow cells are plumbed in series and you do not intend to resample to coarser time bins.                                                                                                                                                                                                                                               |
| 3.0      | Interpolate to Common Wavelengths                                                                | Yes                         | Linearly interpolate absorption and attenuation variables to common wavelength bins.                                                                                                                                                                                      | Linear interpolation between wavelength bins is not common in ACS literature. However, this makes it significantly easier to perform scattering correction and for comparision between absorption and attenuation.                                                                                                                                                        |
| 3.1      | Correct Absorption for Scattering Using Baseline and Proportional Methods                        | Yes                         | Perform a user selected scattering correction to absorption.                                                                                                                                                                                                              | Baseline, Fixed, and Proportional Scattering Correction are provided by *acspype*. For scattering correction that requires a reference wavelength, 715nm is commonly used. However, *acspype* provides a function that will estimate an optimal reference wavelength by using the first red wavelength (>700nm) that is closes to zero.                                   |
| 4.0      | Run QAQC Tests                                                                                   | Yes                         | Run QAQC tests (see [Recommended QAQC Tests](#Recommended QAQC Tests) table for recommended tests).                                                                                                                                                                       | Elapsed Time Test, Internal Temperature Test, Inf Nan Test, Gross Range Test                                                                                                                                                                                                                                                                                              |
| 4.1      | Remove Poor Quality Spectra Based on QAQC Test Results                                           | No (Use Xarray)             | Remove poor quality spectra from analysis. The results of some may tests provide indication of instrument malfunction, occurrence of debric or bubble in flow, or that the data is suspect because of defined limits in the sensor file.                                  |                                                                                                                                                                                                                                                                                                                                                                           |
| 5.0      | Split into Total (a_pg, c_pg), Particulate (a_p, c_p) and Gelbstoff (a_g, c_g) Measurements      | No                          | At this stage, data can be renamed to match its filtration state. Generally p = pg - g                                                                                                                                                                                    | This stage requires knowledge of the filtration state of the seawater.                                                                                                                                                                                                                                                                                                    |
| 6.0      | Filter and Resample                                                                              | No                          | At this stage, data can be passed through a series of smoothing filters and resampled to user-defined bins.                                                                                                                                                               | This stage requires careful consideration of the required resolution for analysis.                                                                                                                                                                                                                                                                                        |
| 7.0      | Compute Advanced Data Products                                                                   | Yes (Ongoing Development)   | Corrected absorption and attenuation products are used to compute advanced data products (e.g. chlorophyll-a from absorption line height and particulate organic carbon).                                                                                                 | 


# Recommended QAQC Tests
Note: If using *acspype* and a flag of 2 (NOT_EVALUATED) is assigned in these tests, that indicates there was a programmatic failure in the test and an issue should be raised on GitHub.

| **Test Name**             | **Test Description**                                                                                                                                                                                                                                                                                                                                                          | **Recommended Settings**                                                        | **Is QARTOD?** | **Possible Results** | **Notes**                                                                                                                                                                                                                                                                                                                                                  |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------|----------------|----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Gap Test                  | The first stage is to compare the data acquisition time to the host computer clock time. The second stage is to compare the known record length agains the number of bytes in the serial buffer.                                                                                                                                                                              | Time Increment = 0.25 (s)                                                       | Yes            | 4, 1                 |                                                                                                                                                                                                                                                                                                                                                            |
| Syntax Test               | The first stage checks if the registration bytes occur at the beginning of the packet. The second stage checks if the packet contains a pad byte at the end. The third stage compares the length of the packet agains the size of the packet descriptor. The fourth stage compares the record length against the length of the packet. The fifth stage verifies the checksum. | Not Applicable                                                                  | Yes            | 4,1                  |                                                                                                                                                                                                                                                                                                                                                            |
| Elapsed Time Test         | Check the elapsed time in each ACS sample to see if it is collected at a reasonable time since the instrument recieved power. The manufacturer states that the ACS takes up to 10 minutes to warm-up and that data may be questionable during this time. On moorings where power is a commodity, this is may not be possible.                                                 | Fail Threshold = 45000 (ms)<br>Suspect Threshold = 240000 (ms)                  | No             | 4,3,1                |                                                                                                                                                                                                                                                                                                                                                            | 
| Internal Temperature Test | Check the internal temperature of the ACS to see if it is within the range specified in the device file. Values outside the device calibration range are flagged as suspect.                                                                                                                                                                                                  | Defined in device file and automatically applied.                               | No             | 3,2,1                |                                                                                                                                                                                                                                                                                                                                                            |
| Inf Nan Test              | Check the uncorrected values for Inf and NaN values. Inf and Nan values can appear in uncorrected measurements for a number of reasons. A common reason is that the one or multple reference counts contain the value of 0, which propagate to NaN when performing a log operation and remain at each processing step.                                                        | Not Applicable                                                                  | No             | 4, 1                 | If a NaN exists in the spectrum, it should probably be discarded. Repeated NaNs (or zero reference counts) in uncorrected values may indicate that factory recalibration is needed or an instrument malfunction.                                                                                                                                           |
| A Greater Than C Test     | Check if uncorrected absorption is greater than attenuation. Consecutive values in a spectrum and over time may indicate bubbles or a stuck object in the flow cell.                                                                                                                                                                                                          | Not Applicable                                                                  | No             | 3, 1                 | This test should be used to consider data suspect, but should not be used to immediate remove data.                                                                                                                                                                                                                                                        |
| Gross Range Test          | On TS and scattering corrected spectrum, run the gross range test, which will assign a flag for each wavelength in a spectra.                                                                                                                                                                                                                                                 | Fail Threshold = [0, 10]<br>Suspect Threshold = [0.001,8.5]                     | Yes            | 4, 3, 1              | Some may find that this results in fail flags in the red wavelengths, even after correction. This                                                                                                                                                                                                                                                          |
| Blanket Gross Range Test  | Assigns a blanket flag to the entire spectrum if a certain percentage of coefficients across the spectrum are flagged as fail. This is useful for identifying spectra that are not suitable for further processing.                                                                                                                                                           | Ignore Wavelengths = [700, 755]<br>Fail Threshold = 10<br>Suspect Threshold = 5 | No             | 4, 3, 1              | This may be useful for identifying poor quality spectra. Users should review the neigboring spectrum samples to see if the issue is persistent or a one-off. If only one spectrum is found as failed while the neighboring spectrum are ok, then it could probably be removed before analysis is performed without a significant impact on the end result. | 
| Rolling Variance Test     | Assigns a flag at each wavelength bin of spectrum if the variance over time exceeds a percentage of the mean. A rolling centered window is used to calculate the variance and a flag is assigned to the central sample.                                                                                                                                                       | Percentage = 10<br>Window Size = 7<br>                                          | No             | 3,1                  | Suspect flags may indicate bubbles or debris in the flow cell.  NOT CURRENTLY IMPLEMENTED.                                                                                                                                                                                                                                                                 |